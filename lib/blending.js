"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var blendingFunc=require("./blendingFunc.js"),isNODE=require("./util.js").isNODE,createCanvas=void 0,loadImage=void 0;function blending(e){var x=this,N=e.srcOriginalImage,O=e.srcTextureImage,C=e.canvasOutput,a=e.blendingMode,j=void 0===a?"multiply":a,t=e.mimeType,y=void 0===t?"jpeg":t,r=e.quality,R=void 0===r?1:r,n=e.outputImageName,T=void 0===n?"./processed":n;return new _promise2.default(function(t,r){var a,n,i,u,o,s,d,c,g,l,m,p,v,f,b,h,w,I,_,D,E,q;return _regenerator2.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:if((isNODE?["jpeg","png"]:["jpeg","png","webp"]).includes(y)){e.next=4;break}return r(new Error("mimeType wrong ! ")),e.abrupt("return");case 4:return a=isNODE?createCanvas():document.createElement("canvas"),n=a.getContext("2d"),i=isNODE?createCanvas():document.createElement("canvas"),u=i.getContext("2d"),C=isNODE?createCanvas():C instanceof HTMLElement&&"CANVAS"===C.tagName?C:document.createElement("canvas"),o=C.getContext("2d"),e.next=12,_regenerator2.default.awrap(loadImage(N));case 12:return s=e.sent,d=s.width,c=s.height,a.width=d,a.height=c,n.drawImage(s,0,0),e.next=20,_regenerator2.default.awrap(loadImage(O,d,c));case 20:g=e.sent,i.width=d,i.height=c,u.drawImage(g,0,0,d,c),C.width=d,C.height=c,l=n.getImageData(0,0,d,c),m=u.getImageData(0,0,d,c),p=0;case 29:if(!(p<l.data.length)){e.next=47;break}if(0===l.data[p+3])return e.abrupt("continue",44);e.next=32;break;case 32:v=l.data[p],f=l.data[p+1],b=l.data[p+2],h=l.data[p+3],w=m.data[p],I=m.data[p+1],_=m.data[p+2],D=m.data[p+3],E=blendingFunc[j]([v,f,b,h],[w,I,_,D]),l.data[p]=E[0],l.data[p+1]=E[1],l.data[p+2]=E[2];case 44:p+=4,e.next=29;break;case 47:o.clearRect(0,0,d,c),o.putImageData(l,0,0),isNODE?(q={},"jpeg"===y?q.quality=R:q.compressionLevel=R,C.toBuffer(function(e,a){e?r(e):t({buffer:a,mimeType:y,outputImageName:T+"."+y})},"image/"+y,q)):C.toBlob(function(e){var a=window.URL.createObjectURL(e);t({blob:e,url:a})},"image/"+y,R);case 50:case"end":return e.stop()}},null,x)})}loadImage=isNODE?(createCanvas=require("canvas").createCanvas,require("canvas").loadImage):require("./util.js").loadImage,module.exports=blending;