"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var blendingFunc=require("./blendingFunc.js"),loadImage=require("./util.js").loadImage;function blending(e){var j=this,D=e.srcOriginalImage,R=e.srcTextureImage,y=e.canvasOutput,a=e.blendingMode,E=void 0===a?"multiply":a,t=e.mimeType,k=void 0===t?"jpeg":t,r=e.quality,C=void 0===r?1:r;return new _promise2.default(function(t,a){var r,n,i,u,d,o,c,g,l,s,m,p,b,f,h,w,_,v,x,I,q;return _regenerator2.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(["jpeg","png","webp"].includes(k)){e.next=4;break}return a(new Error("mimeType wrong ! ")),e.abrupt("return");case 4:return r=document.createElement("canvas"),n=r.getContext("2d"),i=document.createElement("canvas"),u=i.getContext("2d"),y=y instanceof HTMLElement&&"CANVAS"===y.tagName?y:document.createElement("canvas"),d=y.getContext("2d"),e.next=12,_regenerator2.default.awrap(loadImage(D));case 12:return o=e.sent,c=o.width,g=o.height,r.width=c,r.height=g,n.drawImage(o,0,0),e.next=20,_regenerator2.default.awrap(loadImage(R,c,g));case 20:l=e.sent,i.width=c,i.height=g,u.drawImage(l,0,0,c,g),y.width=c,y.height=g,s=n.getImageData(0,0,c,g),m=u.getImageData(0,0,c,g),p=0;case 29:if(!(p<s.data.length)){e.next=47;break}if(0===s.data[p+3])return e.abrupt("continue",44);e.next=32;break;case 32:b=s.data[p],f=s.data[p+1],h=s.data[p+2],w=s.data[p+3],_=m.data[p],v=m.data[p+1],x=m.data[p+2],I=m.data[p+3],q=blendingFunc[E]([b,f,h,w],[_,v,x,I]),s.data[p]=q[0],s.data[p+1]=q[1],s.data[p+2]=q[2];case 44:p+=4,e.next=29;break;case 47:d.clearRect(0,0,c,g),d.putImageData(s,0,0),y.toBlob(function(e){var a=window.URL.createObjectURL(e);t({blob:e,url:a})},"image/"+k,C);case 50:case"end":return e.stop()}},null,j)})}module.exports=blending;