"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var loadImage=require("./util.js").loadImage;function lut(e){var k=this,B=e.srcOriginalImage,H=e.srcLutImage,S=e.canvasOutput,t=e.mimeType,V=void 0===t?"jpeg":t,a=e.quality,z=void 0===a?1:a;return new _promise2.default(function(a,t){var r,n,o,i,u,d,l,g,h,c,m,s,f,p,w,x,_,y,M,v,b,I,q,D,j,E,R,C,L,O,T,A,N,U;return _regenerator2.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(["jpeg","png","webp"].includes(V)){e.next=4;break}return t(new Error("mimeType wrong ! ")),e.abrupt("return");case 4:return r=document.createElement("canvas"),n=r.getContext("2d"),o=document.createElement("canvas"),i=o.getContext("2d"),S=S instanceof HTMLElement&&"CANVAS"===S.tagName?S:document.createElement("canvas"),u=S.getContext("2d"),e.next=12,_regenerator2.default.awrap(loadImage(B));case 12:return d=e.sent,l=d.width,g=d.height,r.width=l,r.height=g,n.drawImage(d,0,0),e.next=20,_regenerator2.default.awrap(loadImage(H));case 20:for(h=e.sent,o.width=h.width,o.height=h.height,i.drawImage(h,0,0),S.width=l,S.height=g,c=n.getImageData(0,0,l,g),m=i.getImageData(0,0,h.width,h.height),s=0;s<c.data.length;s+=4)255,f=c.data[s]/255,p=c.data[s+1]/255,w=c.data[s+2]/255,255,x=63*w,(_={}).y=Math.floor(Math.floor(x)/8),_.x=Math.floor(x)-8*_.y,(y={}).y=Math.floor(Math.ceil(x)/8),y.x=Math.ceil(x)-8*y.y,M={x:.125*_.x+.5/512+.123046875*f,y:.125*_.y+.5/512+.123046875*p},v={x:.125*y.x+.5/512+.123046875*f,y:.125*y.y+.5/512+.123046875*p},b=Math.sqrt(m.data.length/4),I=b,q=4*(Math.floor(512*M.y)*I+(Math.floor(512*M.x)+1)),D=m.data[q-4]/255,j=m.data[q-3]/255,E=m.data[q-2]/255,R=4*(Math.floor(512*v.y)*I+(Math.floor(512*v.x)+1)),C=m.data[R-4]/255,L=m.data[R-3]/255,O=m.data[R-2]/255,T=x-Math.floor(x),A=0*f+1*(D*(1-T)+C*T),N=0*p+1*(j*(1-T)+L*T),U=0*w+1*(E*(1-T)+O*T),255,c.data[s]=255*A,c.data[s+1]=255*N,c.data[s+2]=255*U,c.data[s+3]=255;u.putImageData(c,0,0),S.toBlob(function(e){var t=window.URL.createObjectURL(e);a({blob:e,url:t})},"image/"+V,z);case 31:case"end":return e.stop()}},null,k)})}module.exports=lut;