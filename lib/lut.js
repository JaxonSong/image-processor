"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var isNODE=require("./util.js").isNODE,createCanvas=void 0,loadImage=void 0;function lut(e){var k=this,H=e.srcOriginalImage,S=e.srcLutImage,V=e.canvasOutput,a=e.mimeType,z=void 0===a?"jpeg":a,t=e.quality,F=void 0===t?1:t;return new _promise2.default(function(t,r){var a,n,o,i,u,s,l,d,c,g,m,h,f,p,v,w,x,y,_,D,M,E,I,q,b,O,C,N,j,R,L,T,A,B,U;return _regenerator2.default.async(function(e){for(;;)switch(e.prev=e.next){case 0:if((isNODE?["jpeg","png"]:["jpeg","png","webp"]).includes(z)){e.next=4;break}return r(new Error("mimeType wrong ! ")),e.abrupt("return");case 4:return a=isNODE?createCanvas():document.createElement("canvas"),n=a.getContext("2d"),o=isNODE?createCanvas():document.createElement("canvas"),i=o.getContext("2d"),V=isNODE?createCanvas():V instanceof HTMLElement&&"CANVAS"===V.tagName?V:document.createElement("canvas"),u=V.getContext("2d"),e.next=12,_regenerator2.default.awrap(loadImage(H));case 12:return s=e.sent,l=s.width,d=s.height,a.width=l,a.height=d,n.drawImage(s,0,0),e.next=20,_regenerator2.default.awrap(loadImage(S));case 20:for(c=e.sent,o.width=c.width,o.height=c.height,i.drawImage(c,0,0),V.width=l,V.height=d,g=n.getImageData(0,0,l,d),m=i.getImageData(0,0,c.width,c.height),h=0;h<g.data.length;h+=4)255,f=g.data[h]/255,p=g.data[h+1]/255,v=g.data[h+2]/255,255,w=63*v,(x={}).y=Math.floor(Math.floor(w)/8),x.x=Math.floor(w)-8*x.y,(y={}).y=Math.floor(Math.ceil(w)/8),y.x=Math.ceil(w)-8*y.y,_={x:.125*x.x+.5/512+.123046875*f,y:.125*x.y+.5/512+.123046875*p},D={x:.125*y.x+.5/512+.123046875*f,y:.125*y.y+.5/512+.123046875*p},M=Math.sqrt(m.data.length/4),E=M,I=4*(Math.floor(512*_.y)*E+(Math.floor(512*_.x)+1)),q=m.data[I-4]/255,b=m.data[I-3]/255,O=m.data[I-2]/255,C=4*(Math.floor(512*D.y)*E+(Math.floor(512*D.x)+1)),N=m.data[C-4]/255,j=m.data[C-3]/255,R=m.data[C-2]/255,L=w-Math.floor(w),T=0*f+1*(q*(1-L)+N*L),A=0*p+1*(b*(1-L)+j*L),B=0*v+1*(O*(1-L)+R*L),255,g.data[h]=255*T,g.data[h+1]=255*A,g.data[h+2]=255*B,g.data[h+3]=255;u.clearRect(0,0,l,d),u.putImageData(g,0,0),isNODE?(U={},"jpeg"===z?U.quality=F:U.compressionLevel=F,V.toBuffer(function(e,a){e?r(e):t(a)},"image/"+z,U)):V.toBlob(function(e){var a=window.URL.createObjectURL(e);t({blob:e,url:a})},"image/"+z,F);case 32:case"end":return e.stop()}},null,k)})}loadImage=isNODE?(createCanvas=require("canvas").createCanvas,require("canvas").loadImage):require("./util.js").loadImage,module.exports=lut;